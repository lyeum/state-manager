# src/state_db/Query 디렉토리 구조 보고서

본 보고서는 `src/state_db/Query` 내의 SQL 및 Cypher 쿼리 파일들의 구조와 역할을 정리한 문서입니다. 시스템은 크게 스키마 정의, 초기화, 조회, 업데이트, 추적, 관리 및 디버깅의 8개 카테고리로 나뉩니다.

## 1. 디렉토리별 역할 정의

| 디렉토리             | 역할              | 설명                                                                                           |
| :------------------- | :---------------- | :--------------------------------------------------------------------------------------------- |
| **BASE**             | 기반 구조 및 로직 | 테이블 스키마(B*\*.sql)와 데이터 복제/트리거 로직(L*\*.sql)을 정의합니다. 시스템의 뼈대입니다. |
| **FIRST**            | 초기 데이터 설정  | 시스템 가동 시 필요한 초기 엔티티(아이템, NPC 등)의 기본 데이터를 삽입합니다.                  |
| **INQUIRY**          | 상태 조회         | 현재 세션, 플레이어, NPC, 인벤토리 등의 실시간 상태를 읽기 위한 쿼리들입니다.                  |
| **UPDATE**           | 상태 변경         | HP 변동, 아이템 획득/사용, 위치 이동 등 게임 중 발생하는 상태 변화를 기록합니다.               |
| **START_by_session** | 세션 초기화       | 신규 세션 생성 시 마스터 데이터 복제 및 초기 상태 설정을 담당합니다.                           |
| **TRACE**            | 이력 추적         | 턴(Turn) 및 페이즈(Phase) 단위의 진행 이력을 타임라인 형태로 조회합니다.                       |
| **MANAGE**           | 시스템 관리       | 세션의 생명주기(일시정지, 종료) 및 시나리오/엔티티의 동적 관리를 담당합니다.                   |
| **DEBUG**            | 디버깅 및 분석    | 개발 단계에서 데이터 무결성을 검증하거나 전체 상태를 덤프하여 분석하는 용도입니다.             |

---

## 2. Review (-r) 파일군 정리

파일명 끝에 `-r`이 붙은 파일들은 검토(Review)가 필요하거나, 특정 기능을 수행하기 위해 임시/참조용으로 작성된 쿼리 집합입니다. 주요 파일별 코멘트는 다음과 같습니다.

### DEBUG 카테고리

- **concept-r.sql**: 시스템 설계 단계의 개념 증명용 쿼리.
- **session_dump-r.sql**: 특정 세션의 모든 연관 테이블 데이터를 한 번에 추출하는 진단용 쿼리.

### INQUIRY 카테고리

- **Current_act-r.sql / Current_sequence-r.sql**: 현재 진행 중인 시나리오의 단계(Act, Sequence) 정보를 확인.
- **Location_now-r.sql**: 플레이어의 현재 위치 정보를 조회.
- **Npc_relations-r.sql**: 플레이어와 모든 NPC 간의 관계도를 일괄 확인.
- **Progress_get-r.sql**: 전반적인 시나리오 진행률 데이터를 수집.
- **session/Session\_\*-r.sql**: 특정 세션에 종속된 인벤토리, 플레이어, 페이즈, 턴 등의 정보를 세부적으로 필터링하여 조회.

### UPDATE 카테고리

- **damaged-r.sql / defeated_enemy-r.sql**: 전투 결과에 따른 수치 변화 기록.
- **update_location-r.sql / update_npc_affinity-r.sql**: 위치 및 호감도 변화 기록.
- **earn_item-r.sql / use_item-r.sql**: 아이템 라이프사이클(획득/사용) 처리.
- **record_action_turn-r.sql / record_system_event-r.sql**: 턴 기반 시스템에서 행동 및 시스템 이벤트를 로그에 기록.

### MANAGE & TRACE 카테고리

- **act/select_act-r.sql / sequence/select_sequence-r.sql**: 시나리오 단계 강제 전환 및 선택.
- **phase/phase_check-r.sql / session/paused_check-r.sql**: 현재 페이즈 상태 및 세션 정지 여부 검증.
- **phase_tracing-r.sql**: 페이즈 전환 흐름을 분석하기 위한 통합 조회 쿼리.

---

_참고: -r 파일 중 BASE DDL과 충돌하거나 중복되는 파일은 지속적으로 정리 및 통합되고 있습니다._
