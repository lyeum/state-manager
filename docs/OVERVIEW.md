# GTRPGM 상태 관리 시스템 개요

## 1. 핵심 컨셉: 세션 기반 TRPG 데이터베이스

본 프로젝트는 TRPG(Tabletop Role-Playing Game)의 시나리오와 진행 상태를 관리하기 위한 중앙 데이터베이스 시스템입니다. 핵심적인 아키텍처 원칙은 **"Session 0" 마스터 데이터**와 **세션별 딥 카피(Deep Copy)** 메커니즘에 기반합니다.

- **Session 0**: 모든 시나리오의 원본 데이터(NPC, 적, 아이템 등)는 `session_id`가 `00000000-0000-0000-0000-000000000000`인 "마스터 세션"에 저장됩니다. 이는 작가나 게임 마스터가 설계한 시나리오의 '원형'입니다.

- **세션 딥 카피**: 플레이어가 새로운 게임 세션을 시작하면, 데이터베이스 트리거가 자동으로 'Session 0'의 모든 데이터를 복제하여 새로운 `session_id`를 부여합니다. 이를 통해 각 플레이 세션은 원본 시나리오에 영향을 주지 않는 독립적인 데이터 인스턴스를 갖게 됩니다.

## 2. 데이터베이스 구조 및 명명 규칙

SQL 파일은 기능에 따라 명확하게 분리되어 관리됩니다.

- **`B_*.sql` (Base)**: 테이블 스키마, 인덱스 등 데이터베이스의 정적 구조를 정의합니다.
- **`L_*.sql` (Logic)**: 'Session 0' 데이터를 신규 세션으로 복제하는 함수와 트리거 등 동적 로직을 포함합니다.

## 3. DML 쿼리 디렉토리 구조

실제 게임 플레이 중에 사용되는 DML(데이터 조작어) 쿼리는 기능별로 다음과 같이 구성됩니다.

- **`START_by_session/`**: 세션 초기화 및 마스터 데이터 복제.
- **`INQUIRY/`**: 현재 게임 상태(플레이어, 인벤토리, 위치 등) 조회.
- **`UPDATE/`**: 플레이어 스탯 변화, 아이템 사용 등 상태 변경.
- **`TRACE/`**: `turn_id`와 `phase_id`를 기반으로 게임 진행 이력 추적.
- **`MANAGE/`**: 세션 일시정지, 종료 등 시스템 관리 기능.
- **`DEBUG/`**: 데이터 무결성 검증 및 디버깅용 쿼리.

## 4. 현재 진행 상황

### 완료된 항목

- **기본 아키텍처 설계**: 'Session 0' 딥 카피 메커니즘을 포함한 핵심 DB 구조 설계 완료.
- **DDL/DML 계획 수립**: `Base`, `Logic` 분리 원칙과 기능별 DML 디렉토리 구조 정의 완료.
- **시나리오 주입 API (일부 구현)**:
  - 시나리오 등록을 위한 API 엔드포인트(`/state/scenario/inject`) 및 Pydantic 스키마 구현.
  - 시나리오 및 하위 엔티티(NPC, 적)를 일괄 등록하는 `ScenarioRepository` 구현 및 테스트 완료.

### 진행 중인 항목

- **시나리오 주입 API 고도화**: 현재 구현된 API의 기능을 확장하고 안정화하는 작업이 진행 중입니다.
- **전체 DML 쿼리 작성**: 각 기능 폴더(`INQUIRY`, `UPDATE` 등)에 해당하는 전체 SQL 쿼리 파일 작성 및 검증이 필요합니다.
