{
  "schema_type": "concept_ref",
  "name": "turn",
  "description": "세션 내에서 상태(State)가 실제로 갱신되는 최소 단위. 규칙 판정과 상태 변경의 기준 단위",

  "created_at": {
    "type": "timestamp",
    "auto": "now",
    "description": "Turn 개념 정의 스키마가 생성된 시점"
  },

  "source": {
    "ref_schema": "session_schema.json",
    "ref_field": "current_turn",
    "ownership": "session"
  },

  "turn_definition": {
    "type": "counter",
    "base": "state_update",
    "description": "상태 변경을 포함한 하나의 트랜잭션이 commit 될 때마다 증가하는 세션 단위 카운터"
  },

  "semantics": {
    "turn_increment_rule": {
      "description": "Turn이 증가하는 조건",
      "rules": [
        "RuleEngine 판정 결과로 State 변경이 확정될 때",
        "GM이 상태 적용을 승인(commit)했을 때",
        "Phase 전환으로 인해 상태 스냅샷이 재계산될 때"
      ]
    },

    "turn_not_increment_rule": {
      "description": "Turn이 증가하지 않는 경우",
      "rules": [
        "서술만 발생하고 상태 변경이 없는 경우",
        "동일 상태의 재확인 또는 재서술",
        "캐시 재동기화"
      ]
    },

    "transaction_boundary": {
      "description": "Turn은 하나의 DB transaction과 1:1로 대응되며, commit 시점에만 증가한다",
      "rules": [
        "상태 변경, edge 변경, 로그 기록은 하나의 트랜잭션으로 묶인다",
        "트랜잭션이 rollback 되면 turn은 증가하지 않는다"
      ]
    },

    "scope": {
      "level": "session",
      "shared_with": ["state_db","RuleEngine","play_cache","play_log_DB"]
    }
  },

  "relations": {
    "phase": {
      "relation_type": "belongs_to",
      "description": "각 turn은 특정 phase 컨텍스트 내에서 발생한다",
      "ref_schema": "phase_schema.json"
    }
  },

  "used_by": [
    "GM",
    "RuleEngine",
    "state_db",
    "play_cache",
    "play_log_DB"
  ]
}
